function appViewModel(){function e(){var e,n=/access_token=(.+)/g,o=n.exec(window.location.hash);return o&&o.length>1&&(e=o[1]),e}function n(){u=new google.maps.LatLng(42.3581,-71.0636),d=new google.maps.Map(document.getElementById("map-canvas"),{center:u,zoom:14,disableDefaultUI:!0}),o()}function o(){g.allPlaces([]);var e={location:u,radius:500,types:["food","bar","cafe"]};h=new google.maps.InfoWindow,service=new google.maps.places.PlacesService(d),service.nearbySearch(e,t)}function t(e,n){n===google.maps.places.PlacesServiceStatus.OK&&(p=new google.maps.LatLngBounds,e.forEach(function(e){e.marker=a(e),e.instagrams=ko.observableArray([]),e.isGettingInstagrams=ko.observable(!0),e.isInFilteredList=ko.observable(!0),g.allPlaces.push(e),l(e),p.extend(new google.maps.LatLng(e.geometry.location.lat(),e.geometry.location.lng()))}),d.fitBounds(p))}function a(e){var n=new google.maps.Marker({map:d,position:e.geometry.location});return google.maps.event.addListener(n,"click",function(){document.getElementById(e.id).scrollIntoView(),$("#"+e.id).trigger("click")}),n}function s(e){var n=e.indexOf(","),o=e.slice(0,n)+".";return o}function i(e){var n=e.indexOf(","),o=e.slice(n+1);return o=o.replace(", United States","")}function c(){var e=new Date,n=e.getDay();return 0===n?n=6:n-=1,n}function r(){$(window).height()<$(window).width()?g.photoDimensionValue($(window).height()-160):g.photoDimensionValue(.9*$(window).width())}function l(e){function n(n){var o,t=[],a=e.name.toLowerCase().replace(/[^\w]/gi,"");return n.data.forEach(function(e){o=e.name.toLowerCase().replace(/[^\w]/gi,""),(-1!==a.indexOf(o)||-1!==o.indexOf(a))&&t.push(e.id)}),t}function o(n){var o=$.Deferred();return $.ajax({type:"GET",dataType:"jsonp",cache:!1,url:n,success:function(n){n.data.forEach(function(n){e.instagrams.push(n)}),o.resolve()}}),o.promise()}function t(t){var s=n(t),i=[];s.forEach(function(e){var n="https://api.instagram.com/v1/locations/"+e+"/media/recent?access_token="+g.accessToken();i.push(o(n))}),$.when.apply($,i).then(function(){clearTimeout(a),e.instagrams().sort(function(e,n){return e.likes.count>n.likes.count?-1:e.likes.count<n.likes.count?1:0}),e.isGettingInstagrams(!1)})}var a=setTimeout(function(){e.isGettingInstagrams(!1)},5e3),s="https://api.instagram.com/v1/locations/search?lat="+e.geometry.location.lat()+"&lng="+e.geometry.location.lng()+"&distance=50&access_token="+g.accessToken(),i=$.ajax({type:"GET",dataType:"jsonp",cache:!1,url:s});i.then(function(e){t(e)})}var u,d,h,p,g=this,f="10c5b953e4c649d6934087752396e5a7",m="https://bahalperin.github.io/frontend-nanodegree-neighborhood-map";g.loginUrl="https://api.instagram.com/oauth/authorize/?client_id="+f+"&redirect_uri="+m+"&response_type=token",g.accessToken=ko.observable(),$(window).bind("hashchange",function(){g.accessToken(e())}),$(document).ready(function(){g.accessToken(e())});var v={0:"Monday",1:"Tuesday",2:"Wednesday",3:"Thursday",4:"Friday",5:"Saturday",6:"Sunday"};g.allPlaces=ko.observableArray([]),g.filteredPlaces=ko.computed(function(){return g.allPlaces().filter(function(e){return e.isInFilteredList()})}),g.chosenPlace=ko.observable(),g.query=ko.observable(""),g.searchTerms=ko.computed(function(){return g.query().toLowerCase().split(" ")}),g.search=function(){g.chosenPlace(null),h.setMap(null),g.allPlaces().forEach(function(e){e.isInFilteredList(!1),e.marker.setMap(null)}),g.searchTerms().forEach(function(e){g.allPlaces().forEach(function(n){(-1!==n.name.toLowerCase().indexOf(e)||-1!==n.types.indexOf(e))&&(n.isInFilteredList(!0),n.marker.setMap(d))})})},g.selectPlace=function(e){e===g.chosenPlace()?g.displayInfo(e):(g.filteredPlaces().forEach(function(e){e.marker.setAnimation(null)}),g.chosenPlace(e),g.chosenPhotoIndex(0),e.marker.setAnimation(google.maps.Animation.BOUNCE),g.displayInfo(e))},g.displayingList=ko.observable(!0),g.listToggleIcon=ko.computed(function(){return g.displayingList()?"fa fa-minus-square fa-2x fa-inverse":"fa fa-plus-square fa-2x fa-inverse"}),g.toggleListDisplay=function(){g.displayingList()?g.displayingList(!1):g.displayingList(!0)},g.displayInfo=function(e){var n={placeId:e.place_id};service.getDetails(n,function(n,o){var t="<h4>"+e.name+"</h4>",a="",r="",l="",u="";if(o==google.maps.places.PlacesServiceStatus.OK){n.website&&(t='<h4><a target="_blank" href='+n.website+">"+e.name+"</a></h4>"),n.formatted_phone_number&&(l="<p>"+n.formatted_phone_number+"</p>"),n.formatted_address&&(a="<p>"+s(n.formatted_address)+"</p>",r="<p>"+i(n.formatted_address)+"<p>");var p=c();n.opening_hours&&n.opening_hours.weekday_text&&(openHours=n.opening_hours.weekday_text[p],openHours=openHours.replace(v[p]+":","Today's Hours:"),u="<p>"+openHours+"</p>")}var g='<div class="infowindow">'+t+a+r+l+u+"</div>";h.setContent(g),h.open(d,e.marker),d.panTo(e.marker.position)})},g.viewingPhotos=ko.observable(!1),g.togglePhotoDisplay=function(){g.viewingPhotos()?(g.viewingPhotos(!1),d.setOptions({draggable:!0})):(g.viewingPhotos(!0),d.setOptions({draggable:!1})),r()},g.chosenPhotoIndex=ko.observable(0),g.chosenPhotoViewableIndex=ko.computed(function(){return g.chosenPhotoIndex()+1}),g.chosenPhoto=ko.computed(function(){return g.chosenPlace()?g.chosenPlace().instagrams()[g.chosenPhotoIndex()]:null}),g.captionText=ko.computed(function(){return g.chosenPhoto()&&g.chosenPhoto().caption?g.chosenPhoto().caption.text:"No Caption"}),g.captionOpacity=ko.observable(1),g.toggleCaption=function(){1===g.captionOpacity()?g.captionOpacity(0):g.captionOpacity(1)},g.nextPhoto=function(){g.chosenPhotoIndex()!==g.chosenPlace().instagrams().length-1?g.chosenPhotoIndex(g.chosenPhotoIndex()+1):g.chosenPhotoIndex(0)},g.prevPhoto=function(){0!==g.chosenPhotoIndex()?g.chosenPhotoIndex(g.chosenPhotoIndex()-1):g.chosenPhotoIndex(g.chosenPlace().instagrams().length-1)},g.photoDimensionValue=ko.observable(),g.photoDimension=ko.computed(function(){return g.photoDimensionValue()+"px"}),g.getInstagramStatus=ko.computed(function(){if(g.chosenPlace()){if(0!=g.chosenPlace().instagrams().length&&!g.chosenPlace().isGettingInstagrams())return"Click to view recent Instagrams from "+g.chosenPlace().name;if(g.chosenPlace().isGettingInstagrams())return"Retrieving Instagrams from "+g.chosenPlace().name+" ...";if(0===g.chosenPlace().instagrams().length&&!g.chosenPlace().isGettingInstagrams())return"No Instagrams found from "+g.chosenPlace().name}return""}),n(),window.addEventListener("resize",function(){d.fitBounds(p),r()}),document.addEventListener("keyup",function(e){g.viewingPhotos()&&(37===e.keyCode&&$(".previous-photo").click(),39===e.keyCode&&$(".next-photo").click())}),google.maps.event.addListener(h,"closeclick",function(){g.chosenPlace().marker.setAnimation(null),g.chosenPlace(null)}),$(function(){650>$(window).width()&&g.displayingList()&&g.displayingList(!1)}())}ko.applyBindings(new appViewModel);